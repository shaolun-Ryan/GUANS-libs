<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="d3.v4.min.js"></script>
    <title>Document</title>
</head>
<body>
    <script>
      let  link =  [
                {
                    name: 'Daffodils',//水仙花
                    start: 90,
                    end: 104,
                    isGlutamine: true,
                    isAmicAcid: false,
                    isSalicylicAcid: false,
                    waterContent: 0.7
                },
                {
                    name: 'Cactus',//仙人掌
                    start: 80,
                    end: 92,
                    isGlutamine: false,
                    isAmicAcid: false,
                    isSalicylicAcid: true,
                    waterContent: 0.76
                },
                {
                    name: 'Aloe',//芦荟
                    start: 87,
                    end: 96,
                    isGlutamine: true,
                    isAmicAcid: false,
                    isSalicylicAcid: false,
                    waterContent: 0.72
                },
                {
                    name: 'Bamboo',
                    start: 85,
                    end: 110,
                    isGlutamine: false,
                    isAmicAcid: false,
                    isSalicylicAcid: false,
                    waterContent: 0.80
                },
                {
                    name: 'MorningGlory',//喇叭花
                    start: 56,
                    end: 80,
                    isGlutamine: false,
                    isAmicAcid: true,
                    isSalicylicAcid: false,
                    waterContent: 0.86
                },
                {
                    name: 'Manjulan',//万朱兰
                    start: 43,
                    end: 74,
                    isGlutamine: true,
                    isAmicAcid: false,
                    isSalicylicAcid: false,
                    waterContent: 0.78
                },
                {
                    name: 'Lily',//百合
                    start: 73,
                    end: 83,
                    isGlutamine: false,
                    isAmicAcid: false,
                    isSalicylicAcid: false,
                    waterContent: 0.73
                },
                {
                    name: 'Sunflower',
                    start: 103,
                    end: 120,
                    isGlutamine: false,
                    isAmicAcid: true,
                    isSalicylicAcid: false,
                    waterContent: 0.77
                },
                {
                    name: 'Nepenthes',//猪笼草
                    start: 77,
                    end: 94,
                    isGlutamine: true,
                    isAmicAcid: false,
                    isSalicylicAcid: true,
                    waterContent: 0.89
                },
                {
                    name: 'Mimosa',//含羞草
                    start: 89,
                    end: 92,
                    isGlutamine: false,
                    isAmicAcid: false,
                    isSalicylicAcid: true,
                    waterContent: 0.73
                },
                {
                    name: 'chrysanthemum',//菊花
                    start: 53,
                    end: 73,
                    isGlutamine: false,
                    isAmicAcid: true,
                    isSalicylicAcid: false,
                    waterContent: 0.83
                },
                {
                    name: 'Phalaenopsis',//蝴蝶兰
                    start: 91,
                    end: 110,
                    isGlutamine: true,
                    isAmicAcid: false,
                    isSalicylicAcid: true,
                    waterContent: 0.85
                },
            ]

    let varia = (arr) => {

        
/* **************Begin to build structure data******************** */
        let data = new Object;
        data.nodes = [];
        data.links = [];

        let dataOrigin = {
            axisnode: [],
            link:[]
        }

        /* 按对象的排布顺序找出name,start和end字段 */
        const [name,start,end] = Object.keys(arr[0])
        const attributes = Object.keys(arr[0]).splice(3)
        /* Every data is process into four variables:
        name
        start
        end
        attributes
        */

        /* 求出始末值分布的最大和最小区间 , 是解构语法*/
        let [min,max] = d3.extent(arr.reduce((prev,cur)=>{
            prev.push(cur[start], cur[end])
            return prev
        },[]))

        dataOrigin.axisnode = d3.range(min,max+1)
        dataOrigin.link = arr.map((d,i)=>{
            return {
                name: d[name],
                start: d[start],
                end: d[end]
            }
        })

        /* 给link数组添加 附加属性*/
        arr.forEach((d,i)=>{
            attributes.forEach(_attribute=>{
                dataOrigin.link[i][_attribute] = d[_attribute]
            })
        })
        //check out the build of original dataset
        if(dataOrigin.axisnode.length!=0&&dataOrigin.link.length!=0){
            console.log('Build structure data successfully.',dataOrigin)
        }

/* **************Begin to build output data******************** */

        let dataOutput = {};
        dataOutput.axisnode = [];
        dataOutput.link = [];

        //定义环形的映射比例尺
        let angle = d3.scaleLinear()
        .domain([max,min])
        .range([0, Math.PI])

        dataOutput.axisnode = dataOrigin.axisnode.map((d, i)=>{
            return {
                uid: i,
                tick: d,
                angle: angle(d)
            }
        })

        let fromArray = [], toArray = []
        dataOutput.link = dataOrigin.link.map((d, i)=>{
            let from = d[start], to = d[end],


            fromArrayEle = dataOutput.axisnode.findIndex((item)=>{
                return item.tick == from
            })
            fromArray.push(fromArrayEle)

            toArrayEle = dataOutput.axisnode.findIndex((item)=>{
                return item.tick == to
            })
            toArray.push(toArrayEle)

            return {
                uid: i,
                name: d[name],
                fromId: fromArray[i],
                toId: toArray[i],
                from: d[start],
                to: d[end],
                delta: d[end] - d[start]
            }
        })

        /* 给link数组添加 附加属性*/
        arr.forEach((d,i)=>{
            attributes.forEach(_attribute=>{
                dataOutput.link[i][_attribute] = d[_attribute]
            })
        })

        //check out the build of original dataset
        if(dataOutput.axisnode.length!=0&&dataOutput.link.length!=0){
            console.log('Build output data successfully.',dataOutput)
        }

        return data;
    }

    varia(link)
    </script>
</body>
</html>